# ソフトウェア要件定義書（SRS） (バージョン4.4)

**ドキュメントバージョン:** 4.4  
**作成日:** 2024/12/20  
**作成者:** 大野恭希  
**レビュー者:** -

---

## 1. 目的

本システム「Project Marketplace」は、テンプレート化されたデジタルプロジェクトをオンライン上で売買するプラットフォームである。  
バージョン4.4では、バージョン4.3で導入した**交渉必須フロー**の要件をより明確化し、出品者(Seller)と購入検討者(Buyer)が必ず交渉を経てから合意・決済・成約に至るプロセスを詳細に定義する。

## 2. スコープ

- OAuth認証(Google/GitHub)
- プロジェクト出品（テンプレート販売）
- プロジェクト検索・一覧・詳細閲覧
- **交渉必須フロー**（購入前に必ず「交渉→合意→決済」のステップ）
- メッセージ機能（交渉中のBuyer-Seller間コミュニケーション）
- クレジットカード決済（Squareオンライン決済）
- ユーザープロフィール表示・編集
- ダッシュボード（出品・購入・交渉履歴管理）

## 3. 関係者

- **ユーザー:** 出品者(Seller), 購入者(Buyer)
- **プロダクトマネージャー**
- **開発チーム**

## 4. ビジネス目標

- テンプレート化されたプロジェクトを、交渉・合意・決済フローを通じて、安心・納得価格で売買成立させる。
- 初期6ヶ月で登録1,000ユーザー、月10件成約を目標
- ページロード0.8秒以内、API平均レスポンスタイム200ms(P95)以内

## 5. 用語

- **Project:** テンプレート化されたデジタルコンテンツやサービス
- **Seller:** `users`テーブルで定義されたユーザーの中で、プロジェクトを出品した者
- **Buyer:** プロジェクトを購入検討中のユーザー
- **Negotiation:** BuyerとSeller間で行われる価格・条件交渉プロセス
- **Message:** 交渉中にやり取りされるテキストメッセージ
- **Negotiation Status:** `negotiating`（交渉中）→`agreed`（合意済み）→`completed`（成約）のステータス遷移

## 6. 機能要件

### 6.1 認証

- **FR-1:** Google/GitHub OAuth認証を実装
- **FR-2:** ログイン成功時、`users`テーブルへユーザー情報を登録/更新
- **FR-3:** `role`管理(`none`/`seller`/`buyer`/`both`)を実装
- **FR-4:** 未認証ユーザーは保護エリアへアクセス時、ログインページへリダイレクト
- **FR-5:** ログアウト機能を提供

### 6.2 プロジェクト出品

- **FR-6:** Sellerは`title`,`price`,`description`,`stack`,`image`,`movie`を指定して`projects`へ登録可能
- **FR-7:** 初出品時`role='seller'`または`both'`へ自動変更
- **FR-8:** Sellerは自分が出品した`public`状態のプロジェクトを編集・削除可能
- **FR-9:** 新規出品時`projects.status='public'`（公開状態）

### 6.3 プロジェクト一覧・検索

- **FR-10:** `/projects`でプロジェクト一覧表示(10件/ページ)
- **FR-11:** タイトル・価格帯・スタックでの検索機能
- **FR-12:** 該当なしの場合「該当なし」を表示

### 6.4 プロジェクト詳細閲覧

- **FR-13:** `/projects/{id}`でプロジェクト詳細を表示
- **FR-14:** `status='public'`なプロジェクトには「交渉申し込み」ボタンを表示
- **FR-15:** Buyerが「交渉申し込み」→`negotiations`に`status='negotiating'`で新規レコード挿入  
  成功後、`negotiation_id`の交渉画面へリダイレクト

以下では、旧SRS(交渉フロー前提) をベースにしつつ、**「プロジェクト詳細ページでオープンコメント → 即時決済 → 成約後に交渉メッセージページ」**という最新フローに合わせて、SRSドキュメントをアップデートした例を示します。
古いSRSの差し替え部分（6.5 交渉フロー）を新しい内容に置き換える形で整理しました。

### 新版 SRS: 6.5 交渉 / コメント フロー

### 6.5 交渉 / コメント フロー（2024/12 改訂）

本システムでは、プロジェクト詳細ページで以下の2つのやり取り方法を提供する。
	1.	オープンコメント: 誰でも閲覧できる公開コメント欄
	2.	購入後の交渉メッセージ: Buyer（購入者）とSeller（出品者）だけの譲渡交渉・やり取り

	方針:
		•	Buyerは、購入前に「オープンコメント欄」で質問・条件すり合わせなどを行える。（従来の“交渉”に相当するライトな手段）
	•	即時決済 が可能となっており、Buyerは合意前でも「今すぐ購入」できる。
	•	成約後（=支払い完了後）に、BuyerとSellerだけが利用できる交渉メッセージページが解放され、譲渡リソースの詳細受け渡しを行う。

状態モデル (negotiations.status) の簡素化

旧SRSで定義していた「negotiating → agreed → completed」の厳格なステップを廃止または簡略化し、本バージョンでは以下の状態を用いる。
	1.	open（購入前/公開中）
	•	プロジェクトが status='public' の間は、オープンコメント欄から自由に質問・要望を投稿できる
	•	Buyerが「今すぐ購入」でSquare決済へ進める
	2.	purchased（成約済み）
	•	Square決済完了で projects.status='sold' へ更新
	•	Buyerに「交渉メッセージページ」へのアクセス権が与えられる
	•	※ 厳密な「合意」というステップは廃止し、決済 = 合意 とみなす
	3.	completed（譲渡完了） ※ オプション
	•	BuyerとSeller間の譲渡作業（SNSアカウント移行等）が完了し、両者が合意した場合に管理的に記録するステータス（MVPでは実装省略可）
	•	もし導入するなら Buyer/Sellerどちらかが「譲渡完了」を押し、negotiations.status='completed' に更新

	注意: 旧SRSでの negotiationsテーブルは、購入後の交渉メッセージを管理するため、成約時に negotiationsを新規作成（または purchased に更新）するなどの運用が考えられる。
しかし、本バージョンでは「厳密な交渉ステップ」は任意で、購入後メッセージ = ‘交渉メッセージ’ として柔軟に扱う。

### 6.5.1 オープンコメント (事前やり取り)
	1.	FR-1 (改訂): Buyer, non-party user, いずれも「公開コメント欄」に質問投稿可能（要ログイン）。
	2.	FR-2 (改訂): Sellerはオープンコメントへの返信・追記が可能（任意）
	3.	FR-3 (新): オープンコメントは公開情報として、誰でも閲覧できる。

	目的: 質問や条件確認、雰囲気を掴むライトなコミュニケーション。必ずしも価格交渉を行うわけではない。

### 6.5.2 即時決済 & 購入
	4.	FR-4 (改訂): Buyerはプロジェクト詳細ページの「今すぐ購入(Square決済)」ボタンで支払い可能
	•	projects.status='public' かつ未購入(soldでない)の場合のみ購入ボタンを表示
	5.	FR-5 (改訂): 決済後に projects.status='sold' となり、Buyerが確定する
	6.	FR-6 (改訂): 購入完了ページへ遷移し、そこから「交渉メッセージページ」またはダッシュボードへの導線を表示

### 6.5.3 成約後の交渉メッセージ
	7.	FR-7 (新): Buyerは支払い完了後に「交渉メッセージページ」へアクセス可能
	•	Buyer, Seller以外のユーザー(= non-party)はアクセス不可
	8.	FR-8 (新): 交渉メッセージページでは譲渡内容の細部やSNSアカウント移行などの話し合いを行う
	•	メッセージ送信にはZodなどでバリデーション
	9.	FR-9 (新): システムはメッセージをDB(negotiationsまたはmessages)に保存し、Buyer/Sellerのみ閲覧可

### 6.5.4 オプション: 譲渡完了ステータス
	10.	FR-10 (新): Buyer/Sellerが譲渡を完了したと判断した場合、negotiations.status='completed'に更新できる（任意）
	•	これを使うかどうかはMVPの要件次第
	•	completed後もメッセージ閲覧は可能だが、新規送信はクローズするなど拡張可

### 6.5.5 フロー要点
	1.	オープンコメントで任意の事前やり取り → Buyerが「今すぐ購入」 → Square決済 → 成約(sold)
	2.	成約後: Buyer, Seller 間で譲渡メッセージをやり取り可能 (旧SRSの“交渉メッセージ”に相当)
	3.	交渉開始ボタンは任意
	•	旧SRSでの「交渉申し込み→negotiating」ステップは、最新フローでは省略または任意の拡張機能（価格交渉が本当に必要なケースのみ）。
	•	基本的にはオープンコメントで質問/条件確認が済めば、Buyerは即決済できる仕組み。

### 6.5.6 テーブル例とステータス変更
	•	projects.status: 'public' → 'sold' (Square決済完了時)
	•	negotiations:
	•	MVPでは「購入後の譲渡メッセージ管理」を指すため、必須で作成しなくてもOK。
	•	拡張として“交渉状態”を管理したい場合には 'open' (または 'negotiating'), 'purchased', 'completed'などを使える。
	•	messages: BuyerとSellerのみ閲覧可、外部キーでproject_idかnegotiation_idを紐づける設計

### 6.5.7 結論: 交渉開始ボタンは「不要」だが、オプションで導入可
	•	要件1: 「即時決済の導線をメインにして、買いたい人はすぐに購入できる」
	•	要件2: 「事前に質問したい人はオープンコメントを使う」
	•	要件3: 「成約後に譲渡・細かい相談が必要なら、Buyer/Seller間の交渉メッセージで続ける」

このため、従来のように**「交渉申し込み」ボタンを強制する必要はない**。
ただし、もし「事前にプライベート交渉（値下げ交渉等）を行いたい」ケースがあるなら、**任意機能として「交渉開始ボタン」を設けてnegotiations.status=‘negotiating’**へ移行させる設計も可能。
